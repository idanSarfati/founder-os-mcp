name: Action Guard (CI/CD)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-spec-compliance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install basic dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests google-genai
        # Force upgrade Google AI packages to latest versions
        pip install --upgrade google-generativeai

    - name: Run Action Guard
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PR_TITLE: ${{ github.event.pull_request.title }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        VALIDATION_MODE: ${{ vars.VALIDATION_MODE || 'dual' }}
      run: |
        python .github/scripts/action-guard.py

    - name: Install project dependencies
      if: success()
      run: |
        # Only install project dependencies after validation passes
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Comment on PR
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let specViolations = 'Unable to read spec validation details.';
          let governanceViolations = 'Unable to read governance validation details.';
          let validationMode = process.env.VALIDATION_MODE || 'dual';

          try {
            if (fs.existsSync('validation_result.txt')) {
              specViolations = fs.readFileSync('validation_result.txt', 'utf8');
            }
            if (fs.existsSync('governance_violations.txt')) {
              governanceViolations = fs.readFileSync('governance_violations.txt', 'utf8');
            }
          } catch (error) {
            console.log('Error reading validation results:', error);
          }

          let body = 'üö´ **Action Guard Failed**\n\n';

          if (validationMode === 'dual' || validationMode === 'spec_only') {
            body += '‚ùå **Phase A (Spec Validation):** Failed\n\n';
            body += '**Spec Violations:**\n' + specViolations + '\n\n';
          }

          if (validationMode === 'dual' || validationMode === 'governance_only') {
            body += '‚ùå **Phase B (Governance Enforcement):** Failed\n\n';
            body += '**Governance Violations:**\n' + governanceViolations + '\n\n';
          }

          body += '**Next Steps:**\n';
          if (validationMode === 'dual' || validationMode === 'spec_only') {
            body += '‚Ä¢ Review the requirements in the linked Notion page\n';
          }
          if (validationMode === 'dual' || validationMode === 'governance_only') {
            body += '‚Ä¢ Check the governance rules in your Notion workspace\n';
            body += '‚Ä¢ Remove forbidden libraries or use approved alternatives\n';
          }
          body += '‚Ä¢ Update your code and push changes';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          })